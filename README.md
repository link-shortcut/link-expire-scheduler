# Link Shortcut Expire Scheduler

### 이미 만료된 단축 URL을 DB에서 주기적으로 삭제해주는 스케줄러
<br />

## 기술 스택

- Node.js
- Serverless Framework
<br />

## 스케줄러로 구현한 이유

단축 URL 조회시 현재 시간 기준 만료 일시와 비교해서 가져오기 때문에 서버의 기능상에 문제는 발생하지 않았습니다. 하지만, 만료된 단축 URL을 지속적으로 DB에 보관하게 된다면 가용 URL Path 리소스가 줄어들고, 더 많은 데이터에서 조회하므로 성능상 악영향을 미칠 것으로 예상하였습니다. (URL Path에 Unique 제약 조건 추가되어있음)
따라서 **만료된 단축 URL은 주기적으로 DB 상에서 삭제하기로 결정했습니다**.

### 문제 인식

만료키를 이용해 임의 만료하는 경우 만료 시점에 바로 DB에 DELETE Query를 날려 삭제하면 됩니다.
하지만 **만료일자가 지난 경우 어떤 방법이 가장 효율적일지 고민해보았습니다**.
<br /><br />

### 문제 해결

1. **만료 이후에도 DB에 남아있다가, 만료된 단축 URL에 접속을 요청한 시점에 DB에서 삭제한다.**
   - 구현이 쉽다.
   - 만약 해당 URL Path로 접속 요청을 하지 않는다면 이론상 영구히 남을 수 있다.
   - URL Path의 Unique 제약 조건으로 인해 URL Path의 리소스 낭비가 발생할 수 있다.
2. **매 특정 시점마다 배치 프로그램을 실행해 만료된 단축 URL을 삭제한다.**
   - 만료 시점이 항상 0시 0분이므로, 매일 1번만 돌아도 충분하다.
   - URL Path 리소스 낭비를 최소화할 수 있다.
   - 구현이 1번에 비해 어렵고, 추가적인 관리 포인트가 생긴다.

**결과적으로 URL Path 리소스 효율성 측면, 학습 측면에서 2번을 선택**했습니다.
<br /><br />

그리고 배치 프로그램 구현 방식에 대해 고민했습니다.

1. **Spring Batch로 구현**
   - 대용량 데이터 처리에 최적화되어 고성능
   - 로깅, 통계처리, 트랜잭션 관리 등 재사용 가능한 필수 기능 지원
   - 예외 사항과 비정상적인 동작에 대한 처리 기능 제공
   - Spring Batch에 대한 러닝 커브 존재 (현재 미경험 기술 스택)
   - 별도의 서버 관리 필요
2. **AWS Lambda (EventBridge 트리거)로 구현**
   - 1번에 비해 상대적으로 구현이 쉬움
   - Serverless 서비스로 코드만 작성하면 AWS에서 자동으로 관리를 해줌 (운영이 쉽다)
   - 이전에 사용해본 경험이 있어 빠른 도입이 가능
   - 고성능 대용량 데이터 처리, 예외 사항 처리 등의 기능을 기본적으로 제공해주지 않는다
3. **Linux Crontab으로 구현**
   - 1번에 비해 상대적으로 구현이 쉬움
   - 별도의 Linux 서버 관리 필요
   - 고성능 대용량 데이터 처리, 예외 사항 처리 등의 기능을 기본적으로 제공해주지 않는다
<br />

### 결론

**빠른 도입이 가능하다는 점과 운영이 쉽다는 점으로 2번으로 결정**했습니다.

현재 매일 0시 1분에 AWS Lambda로 구현된 스케줄러가 실행되는 방식으로 만료된 단축 URL을 삭제하고 있습니다.

- 0시 0분에 정확하게 돌았을 경우 삭제되지 않을 수도 있기 때문에 1분 늦게 돌도록 설정
- 단축 URL에 접속시 만료 여부를 확인하기 때문에 1분 정도 텀이 생긴다고 서비스에 문제가 생기진 않는다
- 또한 배치 완료 후 슬랙에 작업 결과를 알림으로 보내준다. (성공 / 실패 여부, 삭제된 단축 URL 개수 등)
